# README
## Discord Bot
### 本リポジトリの目的
- 7Dasy to Dieサーバ用のDiscord Botの作成し、  
  Discord BotにSlash Commandを実装して、DiscordのスラッシュコマンドよりAWS EC2のインスタンスの起動・停止を実現する
- あとは勉強のため！
- DiscordとGithub連携確認用に更新

---

### 今回実装している機能（★後で細かい手順をアップロード予定）
  - EC2はスポットインスタンスを利用
  - スポットインスタンスを利用のため、起動するたびにデータがクリアされてしまうが、  
    データがクリアされないようにEBSを30GB利用してデータ保管
  - Linuxにサービスを登録して、インスタンス起動時に7Days to Dieを起動
  - Discord Botを利用し、Discordからスラッシュコマンドで誰でもサーバの停止・起動を実行可能
  - [サーバ接続ユーザを確認して0人であればシャットダウンする機能](#サーバ接続ユーザが存在しなければ自動シャットダウンする機能)
    - サーバ停止忘れ防止の為、1時間毎にサーバ接続ユーザを確認し、接続ユーザが0人であればサーバをシャットダウン


---

## サーバ接続ユーザが存在しなければ自動シャットダウンする機能
- サーバ側の以下パスにシェルファイルを配置
  - /opt/games/7days/listplayers.sh
    - telnetを利用して7Days to Dieのサーバに接続ユーザが存在するかを確認するシェルファイル
    - 今回、EC2ではスポットインスタンスを利用しているため、環境変数を利用せずにファイル内にパスワードを直書きしている。（Gitにアップロードしているファイルに適宜パスワードを設定）
  - /etc/cron.hourly/idleshutdown.sh
    - 1時間毎にlistplayers.shを実行し、接続ユーザが存在しなければサーバをシャットダウンするシェルファイル（以下ディレクトリが1時間ごとに実行されるっぽい）
  - 権限系のエラーが出るのであれば、大体以下のコマンド実行しておけばいけるはず。
    - sudo chmod +x /opt/games/7days/listplayers.sh
    - sudo chmod +x /etc/cron.hourly/idleshutdown.sh
  